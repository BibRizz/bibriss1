<script src='scripts/jszip.js'></script>
<script src='scripts/filesaver.js'></script>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<style>
  body{
    background-color:black;
    display:flex;
    flex-direction: column;
  }
  html, body {
    margin: 0; 
    height: 100%; 
    overflow: hidden;
  }
  ::placeholder{
    color:inherit;
  }
</style>
<body>
  
</body>
<script>
  var fontsize=2560/screen.width*6;

  var titlecolorl=document.createElement("label");
  titlecolorl.for="titlecolor";
  titlecolorl.style.color="white";
  document.body.appendChild(titlecolorl);
  
  var titlecolor=document.createElement("input");
  titlecolor.type="color";
  titlecolor.name="titlecolor";
  titlecolor.id="titlecolor";
  titlecolor.style.position="relative";
  titlecolor.style.left='50%';
  titlecolor.style.borderRadius="25px";
  titlecolor.style.border="2px solid white";
  titlecolor.style.width="10%";
  titlecolor.value="white";
  titlecolor.style.textAlign="center";
  titlecolor.style.height="6%";
  titlecolor.style.transform='translateX(-50%)';
  document.body.appendChild(titlecolor);

  var titletext=document.createElement("input");
  titletext.type="text";
  titletext.id="titletext";
  titletext.placeholder="Title text";
  titletext.style.position="relative";
  titletext.style.left='50%';
  titletext.style.fontSize=fontsize+"px";
  titletext.style.borderRadius="25px";
  titletext.style.border="2px solid white";
  titletext.style.color="white";
  titletext.style.width="45%";
  titletext.style.textAlign="center";
  titletext.style.height="6%";
  titletext.style.background="transparent";
  titletext.style.transform='translateX(-50%)';
  document.body.appendChild(titletext);

  var sbpt=document.createElement("input");
  sbpt.type="text";
  sbpt.placeholder="Search bar placeholder text";
  sbpt.style.position="relative";
  sbpt.style.left='50%';
  sbpt.style.borderRadius="25px";
  sbpt.id="sbpt";
  sbpt.style.fontSize=fontsize+"px";
  sbpt.style.border="2px solid white";
  sbpt.style.color="white";
  sbpt.style.width="45%";
  sbpt.style.textAlign="center";
  sbpt.style.height="6%";
  sbpt.style.background="transparent";
  sbpt.style.transform='translateX(-50%)';
  document.body.appendChild(sbpt);
  
  var sbtc=document.createElement("input");
  sbtc.type="text";
  sbtc.id="sbtc";
  sbtc.style.background="transparent";
  sbtc.placeholder="Search bar text color";
  sbtc.style.position="relative";
  sbtc.style.left='50%';
  sbtc.style.fontSize=fontsize+"px";
  sbtc.style.borderRadius="25px";
  sbtc.style.border="2px solid white";
  sbtc.style.color="white";
  sbtc.style.width="45%";
  sbtc.style.textAlign="center";
  sbtc.style.height="6%";
  sbtc.style.transform='translateX(-50%)';
  document.body.appendChild(sbtc);

  var sbbc=document.createElement("input");
  sbbc.type="text";
  sbbc.id="sbbc";
  sbbc.style.background="transparent";
  sbbc.placeholder="Search bar border color";
  sbbc.style.position="relative";
  sbbc.style.left='50%';
  sbbc.style.fontSize=fontsize+"px";
  sbbc.style.borderRadius="25px";
  sbbc.style.border="2px solid white";
  sbbc.style.color="white";
  sbbc.style.width="45%";
  sbbc.style.textAlign="center";
  sbbc.style.height="6%";
  sbbc.style.transform='translateX(-50%)';
  document.body.appendChild(sbbc);

  var sbbs=document.createElement("input");
  sbbs.type="text";
  sbbs.id="sbbs";
  sbbs.style.background="transparent";
  sbbs.placeholder="Search bar border size (in pixels)";
  sbbs.style.position="relative";
  sbbs.style.left='50%';
  sbbs.style.fontSize=fontsize+"px";
  sbbs.style.borderRadius="25px";
  sbbs.style.border="2px solid white";
  sbbs.style.color="white";
  sbbs.style.width="45%";
  sbbs.style.textAlign="center";
  sbbs.style.height="6%";
  sbbs.style.transform='translateX(-50%)';
  document.body.appendChild(sbbs);

  var sbbac=document.createElement("input");
  sbbac.type="text";
  sbbac.id="sbbac";
  sbbac.style.background="transparent";
  sbbac.placeholder="Search bar background color (put transparent if none)";
  sbbac.style.position="relative";
  sbbac.style.left='50%';
  sbbac.style.fontSize=fontsize+"px";
  sbbac.style.borderRadius="25px";
  sbbac.style.border="2px solid white";
  sbbac.style.color="white";
  sbbac.style.width="45%";
  sbbac.style.textAlign="center";
  sbbac.style.height="6%";
  sbbac.style.transform='translateX(-50%)';
  document.body.appendChild(sbbac);

  var tabtitle=document.createElement("input");
  tabtitle.type="text";
  tabtitle.id="tabtitle";
  tabtitle.style.background="transparent";
  tabtitle.placeholder="Tab title";
  tabtitle.style.position="relative";
  tabtitle.style.fontSize=fontsize+"px";
  tabtitle.style.left='50%';
  tabtitle.style.borderRadius="25px";
  tabtitle.style.border="2px solid white";
  tabtitle.style.color="white";
  tabtitle.style.width="45%";
  tabtitle.style.textAlign="center";
  tabtitle.style.height="6%";
  tabtitle.style.transform='translateX(-50%)';
  document.body.appendChild(tabtitle);

  var tabinput=document.createElement("input");
  tabinput.style.display="none";
  tabinput.type="file";
  tabinput.accept="image/*";
  tabinput.onchange = function() {
    let input = this.files[0];
    let text;
    if (input) {
      text = tabinput.value.replace("C:\\fakepath\\", "");
    }
    tabimg.innerHTML = text;
  };
  tabinput.id="tabinput";
  document.body.appendChild(tabinput);
  
  var tabimg=document.createElement("button");
  tabimg.id="tabimg";
  tabimg.style.background="transparent";
  tabimg.style.cursor="pointer";
  tabimg.style.position="relative";
  tabimg.style.fontSize=fontsize+"px";
  tabimg.style.left='50%';
  tabimg.style.borderRadius="25px";
  tabimg.style.border="2px solid white";
  tabimg.style.color="white";
  tabimg.style.width="25%";
  tabimg.style.textAlign="center";
  tabimg.style.height="6%";
  tabimg.innerText="Upload a tab icon";
  tabimg.style.transform='translateX(-50%)';
  document.body.appendChild(tabimg);
  document.getElementById('tabimg').addEventListener('click', () => { 
    document.getElementById('tabinput').click();
  });

  var bginput=document.createElement("input");
  bginput.style.display="none";
  bginput.type="file";
  bginput.onchange = function() {
    let input = this.files[0];
    let text;
    if (input) {
      text = bginput.value.replace("C:\\fakepath\\", "");
    }
    bgimg.innerHTML = text;
  };
  bginput.id="bginput";
  bginput.accept="image/*";
  document.body.appendChild(bginput);
  
  var bgimg=document.createElement("button");
  bgimg.id="bgimg";
  bgimg.style.background="transparent";
  bgimg.style.cursor="pointer";
  bgimg.style.position="relative";
  bgimg.style.fontSize=fontsize+"px";
  bgimg.style.left='50%';
  bgimg.style.borderRadius="25px";
  bgimg.style.border="2px solid white";
  bgimg.style.color="white";
  bgimg.style.width="25%";
  bgimg.style.textAlign="center";
  bgimg.style.height="6%";
  bgimg.innerText="Upload a background image";
  bgimg.style.transform='translateX(-50%)';
  document.body.appendChild(bgimg);
  document.getElementById('bgimg').addEventListener('click', () => { 
    document.getElementById('bginput').click();
  });

  var cont=document.createElement("div");
  cont.style.position="absolute";
  cont.style.left='0px';
  cont.style.bottom="0px";
  cont.style.border="none";
  cont.style.width="100%";
  cont.style.textAlign="center";
  cont.style.height="6%";
  cont.style.background="transparent";
  document.body.appendChild(cont);
  
  var preview=document.createElement("button");
  preview.style.background="transparent";
  preview.id="preview";
  preview.style.height="100%";
  preview.style.width="15%";
  preview.style.fontSize=fontsize+"px";
  preview.style.borderRadius="25px";
  preview.style.bottom="0px";
  preview.addEventListener("click", previewcode);
  preview.style.border="2px solid white";
  preview.innerText="preview";
  preview.style.color="white";
  preview.style.textAlign="center";
  cont.appendChild(preview);

  var done=document.createElement("button");
  done.style.background="transparent";
  done.style.right='40%';
  done.style.fontSize=fontsize+"px";
  done.id="done";
  done.style.height="100%";
  done.style.width="15%";
  done.style.borderRadius="25px";
  done.style.bottom="0px";
  done.addEventListener("click", waitforcode);
  done.style.border="2px solid white";
  done.innerText="done!";
  done.style.color="white";
  done.style.textAlign="center";
  cont.appendChild(done);
  
  var codelist=[];
  var namelist=[];
  function getHtml(file){
    return new Promise((resolve) => {
      fetch("/files"+file)
        .then((response) => {
          return response.text();
        })
        .then((html) => {
          resolve(html);
        });
    });
  }
  var filelist=["/app.json","/idk","/index.js","/index.mjs","/LICENSE","/main.sh","/main.zip","/node_modules/bare-server-node/AbstractMessage.js","/node_modules/bare-server-node/app.js","/node_modules/bare-server-node/app.mjs","/node_modules/bare-server-node/cli/server.js","/node_modules/bare-server-node/cli/y","/node_modules/bare-server-node/encodeProtocol.js","/node_modules/bare-server-node/headerUtil.js","/node_modules/bare-server-node/LICENSE","/node_modules/bare-server-node/package.json","/node_modules/bare-server-node/README.md","/node_modules/bare-server-node/Server.js","/node_modules/bare-server-node/Server.mjs","/node_modules/bare-server-node/splitHeaderUtil.js","/node_modules/bare-server-node/V1.js","/node_modules/bare-server-node/V2.js","/node_modules/fetch-headers/headers.d.ts","/node_modules/fetch-headers/headers.js","/node_modules/fetch-headers/LICENSE","/node_modules/fetch-headers/package.json","/node_modules/fetch-headers/README.md","/node_modules/fetch-headers/test/header-setcookie.any.js","/node_modules/fetch-headers/test/http-loader.js","/node_modules/fetch-headers/test/own-misc-test.any.js","/node_modules/fetch-headers/test/wpt_test.js","/node_modules/fetch-headers/test/y","/node_modules/fetch-headers/tsconfig.json","/node_modules/mime/CHANGELOG.md","/node_modules/mime/cli.js","/node_modules/mime/LICENSE","/node_modules/mime/mime.js","/node_modules/mime/package.json","/node_modules/mime/README.md","/node_modules/mime/src/build.js","/node_modules/mime/src/test.js","/node_modules/mime/src/y","/node_modules/mime/types.json","/node_modules/node-static/benchmark/node-static-0.3.0.txt","/node_modules/node-static/bin/cli.js","/node_modules/node-static/examples/file-server.js","/node_modules/node-static/lib/node-static.js","/node_modules/node-static/lib/node-static/util.js","/node_modules/node-static/LICENSE","/node_modules/node-static/package.json","/node_modules/node-static/README.md","/node_modules/node-static/test/fixtures/empty.css","/node_modules/node-static/test/fixtures/hello.txt","/node_modules/node-static/test/fixtures/index.html","/node_modules/node-static/test/fixtures/there","/node_modules/node-static/test/fixtures/there/index.html","/node_modules/node-static/test/integration/node-static-test.js","/node_modules/node-static/test/integration/y","/package.json","/package-lock.json","/Procfile","/README.md","/replit.nix","/ssl/default.cert","/ssl/default.key","/ssl/y","/static/style.css","/static/styles.css","/static/sw.js","/static/uv/uv.bundle.js","/static/uv/uv.config.js","/static/uv/uv.handler.js","/static/uv/uv.sw.js"];
  getHtml(filelist,codelist,namelist);

  function hs(hideorshow){
    if (hideorshow=="hide"){
      const elems=document.getElementsByTagName("*");
      for (const elem of elems) {
        if (elem.tagName!="BODY" && elem.tagName!="HEAD" && elem.tagName!="HTML"){
          elem.style.pointerEvents="none";
          elem.style.opacity="0";
        }
      }
    }
    if (hideorshow=="show"){
      const elems=document.getElementsByTagName("*");
      for (const elem of elems) {
        if (elem.tagName!="BODY" && elem.tagName!="HEAD" && elem.tagName!="HTML"){
          elem.style.pointerEvents="auto";
          elem.style.opacity="1";
        }
      }
    }
  }

  function imgs1(){
    return new Promise((resolve) => {
      var reader = new FileReader();
      reader.addEventListener(
        "load",
        () => {
          resolve(reader.result);
        },
        false,
      );
      reader.readAsDataURL(document.getElementById("bginput").files[0]);
    });
  }

  function hexToRgb(hex) {
    hex=hex.replace("#","");
    var bigint = parseInt(hex, 16);
    var r = (bigint >> 16) & 255;
    var g = (bigint >> 8) & 255;
    var b = bigint & 255;

    return r + "," + g + "," + b;
  }


  
  function imgs2(){
    return new Promise((resolve) => {
      var reader1 = new FileReader();
      reader1.addEventListener(
        "load",
        () => {
          resolve(reader1.result);
        },
        false,
      );
      reader1.readAsDataURL(document.getElementById("tabinput").files[0]);
    });
  }
  
  async function previewcode(){
    hs("hide");
    var html=await getHtml("/static/index.html");
    html=html.toString();

    var color=hexToRgb(document.getElementById("titlecolor").value.toString());
    html=html.replaceAll("---titlecolor---","rgb("+color+")");
    
    html=html.replaceAll("---documenttitle---",document.getElementById("titletext").value.toString());
    html=html.replaceAll("---tabtitle---",document.getElementById("tabtitle").value.toString());
    html=html.replaceAll("---bordersize---",document.getElementById("sbbs").value.toString());
    html=html.replaceAll("---bordercolor---",document.getElementById("sbbc").value.toString());
    html=html.replaceAll("---placeholder---",document.getElementById("sbpt").value.toString());
    html=html.replaceAll("---sbtc---",document.getElementById("sbtc").value.toString());
    html=html.replaceAll("---sbbac---",document.getElementById("sbbac").value.toString());
    
    if (document.getElementById("bgimg").innerText!="Upload a background image"){
      var img1=await imgs1();
      html=html.replaceAll("---bg---",img1);
    }
    if (document.getElementById("tabimg").innerText!="Upload a tab icon"){
      var img2=await imgs2();
      html=html.replaceAll("---icon---",img2);
    }

    function waitingidkidkidk(){
      var frame=document.createElement("iframe");
      frame.src='data:text/html;charset=utf-8,' + encodeURIComponent(html);
      frame.style.position="absolute";
      frame.style.overflow="hidden";
      frame.style.left="0px";
      frame.style.opacity="1";
      frame.style.top="0px";
      frame.style.border="none";
      frame.style.width="100%";
      frame.style.height="100%";
      frame.scrolling="no";
      document.body.appendChild(frame);
  
      var x = document.createElement('img');
      x.style.cursor="pointer";
      x.style.position = "absolute";
      x.style.width = "50px";
      x.style.height = "50px";
      x.src = "/imgs/x.png";
      x.style.zIndex = "99999999999999999999";
      x.style.right = "1%";
      x.style.top = "1%";
      x.onclick = function() {
        frame.remove();
        hs("show");
        x.remove();
      };
      document.body.appendChild(x);
    }
    setTimeout(waitingidkidkidk,200);
  }
  
  async function waitforcode(){
    hs("hide");
    var zip = new JSZip();
    var loadbar=document.createElement("div");
    loadbar.style.position="absolute";
    loadbar.style.width="0%";
    loadbar.style.height="15px";
    loadbar.style.bottom="53%";
    loadbar.style.backgroundColor="white";
    loadbar.style.left="0px";
    loadbar.style.transition="all .5s linear";
    document.body.appendChild(loadbar);
    var loadamount=0;

    var loadfile=document.createElement("div");
    loadfile.style.position="absolute";
    loadfile.style.color="white";
    loadfile.style.textAlign="center";
    loadfile.style.bottom="45%";
    loadfile.style.left="0px";
    loadfile.style.width="100%";
    loadfile.style.height="15px";
    loadfile.style.fontSize="15px";
    document.body.appendChild(loadfile);

    var text=document.createElement("h2");
    loadfile.appendChild(text);

    var percent=document.createElement("div");
    percent.style.position="absolute";
    percent.style.color="white";
    percent.style.textAlign="center";
    percent.style.top="15%";
    percent.style.left="0px";
    percent.style.width="100%";
    percent.style.height="15px";
    percent.style.fontSize="30px";
    document.body.appendChild(percent);

    var text=document.createElement("h2");
    loadfile.appendChild(text);

    var ptext=document.createElement("h2");
    percent.appendChild(ptext);
    
    for (var i=0; i<filelist.length; i++){
      text.innerText=filelist[i];
      var code=await getHtml(filelist[i]);
      loadamount=loadamount+100/filelist.length;
      ptext.innerText=Math.round(loadamount)+"%";
      loadbar.style.width=loadamount+"%";
      console.log("code"+filelist[i]+": "+code);

      zip.file("files"+filelist[i].toString(),code.toString());
    }

    var html=await getHtml("/static/index.html");
    html=html.toString();
    html=html.replaceAll("---titlecolor---",document.getElementById("titlecolor").value.toString());
    html=html.replaceAll("---documenttitle---",document.getElementById("titletext").value.toString());
    html=html.replaceAll("---tabtitle---",document.getElementById("tabtitle").value.toString());
    html=html.replaceAll("---bordersize---",document.getElementById("sbbs").value.toString());
    html=html.replaceAll("---bordercolor---",document.getElementById("sbbc").value.toString());
    html=html.replaceAll("---placeholder---",document.getElementById("sbpt").value.toString());
    html=html.replaceAll("---sbtc---",document.getElementById("sbtc").value.toString());
    html=html.replaceAll("---sbbac---",document.getElementById("sbbac").value.toString());

    if (document.getElementById("bgimg").innerText!="Upload a background image"){
      zip.file("files/static/img/"+bginput.value.replace("C:\\fakepath\\", ""), bginput.files[0], {binary: true});
      html=html.replaceAll("---bg---","/img/"+bginput.value.replace("C:\\fakepath\\", ""));
    }
    if (document.getElementById("tabimg").innerText!="Upload a tab icon"){
      zip.file("files/static/img/"+tabinput.value.replace("C:\\fakepath\\", ""), tabinput.files[0], {binary: true});
      html=html.replaceAll("---icon---","/img/"+tabinput.value.replace("C:\\fakepath\\", ""));
    }
    
    console.log(html);

    zip.file("files/static/index.html",html);
        
    zip.generateAsync({type:"blob"}).then(function (content) {
      saveAs(content, "ForgedFreedom.zip");
    });
    console.log("done!");
  }
</script>
